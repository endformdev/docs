---
import { Code } from "@astrojs/starlight/components";

interface Props {
	suite: "existing" | "demo";
	target: "local" | "remote" | "vercel";
}

const { suite, target } = Astro.props;

// For demo + vercel, we skip the workflow file and go straight to deploy
const isDemoVercel = suite === "demo" && target === "vercel";
---

<h2 id="connect-github">1. Connect GitHub</h2>

<p>Install the Endform GitHub App to enable OIDC authentication in your workflows:</p>

<p><a href="https://endform.dev/app" target="_blank" rel="noopener noreferrer">Connect GitHub in Dashboard →</a></p>

{target === 'vercel' && (
  <>
    <h2 id="connect-vercel">2. Connect Vercel</h2>
    <p>Connect your Vercel account to automatically test preview deployments:</p>
    <p><a href="https://endform.dev/app" target="_blank" rel="noopener noreferrer">Connect Vercel in Dashboard →</a></p>
  </>
)}

{isDemoVercel && (
  <>
    <h2 id="deploy-demo">3. Deploy the demo project</h2>
    <p>Deploy our demo repository to your Vercel account. This will automatically configure the project and start running tests on main:</p>
    <p><a href="https://vercel.com/new/clone?repository-url=https%3A%2F%2Fgithub.com%2Fendformdev%2Fplaywright-tutorial" target="_blank" rel="noopener noreferrer">Deploy with Vercel →</a></p>
    <p><small>Once deployed, tests will automatically run. Results will appear in the dashboard shortly.</small></p>
  </>
)}

{!isDemoVercel && (
  <>
    <h2 id="create-workflow">{target === 'vercel' ? '3' : '2'}. Create workflow file</h2>
    <p>Create <code>.github/workflows/endform-e2e.yml</code> in your repository:</p>

    {target === 'remote' && (
      <Code lang="yaml" title=".github/workflows/endform-e2e.yml" code={`name: Run end to end tests with endform

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  id-token: write # required for authentication with Endform

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up pnpm (or whichever package manager you use)
        uses: pnpm/action-setup@v4

      - name: Install Node
        uses: actions/setup-node@v4

      - name: Run end to end tests with endform
        working-directory: . # where your playwright suite is located
        env:
          BASE_URL: https://url-to-your-server.com
        run: |
          npx endform@latest test`} />
    )}

    {target === 'local' && (
      <Code lang="yaml" title=".github/workflows/endform-e2e.yml" code={`name: Run end to end tests with endform

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  id-token: write # required for authentication with Endform

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up pnpm (or whichever package manager you use)
        uses: pnpm/action-setup@v4

      - name: Install Node
        uses: actions/setup-node@v4
      
      # Any other setup needed for your local server to run...

      - name: Run end to end tests with endform
        working-directory: . # where your playwright suite is located
        run: |
          npx endform@latest test`} />
    )}

    {target === 'vercel' && (
      <Code lang="yaml" title=".github/workflows/endform-e2e.yml" code={`name: Run end to end tests with endform

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  id-token: write # required for authentication with Endform

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up pnpm (or whichever package manager you use)
        uses: pnpm/action-setup@v4

      - name: Install Node
        uses: actions/setup-node@v4

      - name: Wait for Vercel deployment
        uses: endformdev/actions/await-vercel-deployment@main
        with:
          project-name: your-vercel-project-name
          set-url-env-var: BASE_URL # Sets the Vercel preview URL as this environment variable

      - name: Run end to end tests with endform
        working-directory: . # where your playwright suite is located
        run: |
          npx endform@latest test`} />
    )}

    <h2 id="commit-changes">{target === 'vercel' ? '4' : '3'}. Commit your changes</h2>
    <p>Stage and commit your workflow file:</p>
    <Code lang="bash" code='git add -A && git commit -m "Add endform github actions workflow"' />

    <h2 id="push-to-trigger">{target === 'vercel' ? '5' : '4'}. Push to trigger tests</h2>
    <p>Push your changes to trigger the workflow on your next pull request:</p>
    <Code lang="bash" code="git push" />
  </>
)}

<h2 id="view-your-results">View your results</h2>

<p>Once your tests complete, results will appear in the <a href="https://endform.dev/app">Endform dashboard</a>.</p>
